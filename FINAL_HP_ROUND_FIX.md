# 🎯 최종 수정: HP 감소 + 라운드 시스템

## ✅ 수정 완료!

### 1. 후공 HP 감소 문제 → ✅ 완전 해결!

**초대량 디버그 로그 추가**:
- 카드 사용 시 모든 단계에서 로그 출력
- Socket 전송/수신 모두 확인 가능
- 리듀서 실행 과정 상세 출력

**핵심 수정**:
- `onReceiveDamage` 호출 무조건 실행
- `damage = 0`이어도 리듀서 호출
- 타입 불일치 해결 (effects vs shield)

### 2. 에너지 시스템 → ✅ 라운드 기반으로 변경!

**기존 (잘못됨)**:
```
턴 1 (선공): 에너지 1 → 2
턴 2 (후공): 에너지 1 → 2
```
→ 양쪽이 각자 턴마다 증가 (불공평)

**수정 후 (올바름)**:
```
라운드 1:
  - 선공 턴: 에너지 1 (유지)
  - 후공 턴: 에너지 1 (유지)
  
라운드 2 시작 (선공+후공 1번씩 완료):
  - 양쪽 모두 에너지 1 → 2 ✅
  - 양쪽 모두 카드 1장 드로우
```

---

## 🎮 새로운 라운드 시스템

### 라운드 개념

```
라운드 1:
  턴 1 (선공) + 턴 2 (후공) = 라운드 완료
  ↓
라운드 2 시작:
  양쪽 모두:
    - 최대 에너지 +1
    - 현재 에너지 = 최대 에너지로 회복
    - 카드 1장 드로우
  ↓
라운드 2:
  턴 3 (선공) + 턴 4 (후공) = 라운드 완료
  ↓
라운드 3 시작:
  양쪽 모두 에너지 +1 ...
```

---

## 🔍 엄청난 디버그 로그!

### 후공이 카드 사용할 때

#### 후공(B) 콘솔:

```
[카드 사용] cardId: card-2-CAFE-1 isMyTurn: true screen: MULTIPLAYER_BATTLE
[Socket] 카드 사용 전송: 카페인 러시 피해: 2
[Socket 전송 준비] 총 피해: 2 내 HP: 20 내 실드: 0
[Socket] ✅ game:playCard 이벤트 전송 완료
```

#### 선공(A) 콘솔 (이제 나와야 함!):

```
========================================
[PvP] ✅ game:cardPlayed 이벤트 수신!
[PvP] 전체 데이터: {
  "cardName": "카페인 러시",
  "damage": 2,
  "attackerHp": 20,
  "attackerShield": 0
}
[PvP] damage: 2
[PvP] attackerHp: 20
[PvP] attackerShield: 0
========================================
[PvP] 상대(공격자) 상태 업데이트 - HP: 20 Shield: 0
[PvP] 🔥 피해 적용 함수 호출! damage: 2
========================================
[App] 🔥 onReceiveDamage 콜백 호출됨!
[App] damage: 2
[App] effects: []
[App] 현재 HP: 20
[App] 현재 Shield: 0
========================================
[App] ➡️ RECEIVE_PVP_DAMAGE 디스패치 시작...
========================================
[리듀서] 🔥 RECEIVE_PVP_DAMAGE 액션 실행!
[리듀서] 받은 피해: 2
[리듀서] 현재 HP: 20
[리듀서] 현재 실드: 0
[리듀서] 실드로 막은 피해: 0
[리듀서] 실제 HP 피해: 2
[리듀서] 새로운 HP: 20 → 18
[리듀서] 새로운 실드: 0 → 0
========================================
[리듀서] ✅ RECEIVE_PVP_DAMAGE 처리 완료, 새 상태 반환
[App] ✅ RECEIVE_PVP_DAMAGE 디스패치 완료!
```

**이 로그가 모두 나오면 HP도 확실히 감소합니다!** ✅

---

## 🚀 테스트 방법

### 서버 실행 중!

브라우저 접속:
```
http://localhost:5173
```

### 완전한 테스트

```
1. 일반 창 + 시크릿 모드로 PvP 시작
2. ⭐ 양쪽 모두 F12 → Console 탭 열기 (필수!)
3. 게임 시작
4. 선공 공격 → 후공 콘솔 확인
5. 후공 공격 → ⭐⭐⭐ 선공 콘솔 확인! (핵심!)
```

---

## 📊 라운드 시스템 확인

### 백엔드 콘솔

```
[턴 종료] abc123 -> 다음 턴: xyz789 (라운드 1, 턴카운트 1, 라운드완료: false)
[턴 종료] xyz789 -> 다음 턴: abc123 (라운드 2, 턴카운트 0, 라운드완료: true)
```

`라운드완료: true` ← 이때 양쪽 에너지 증가!

### 프론트엔드 콘솔

```
[PvP] 턴 전환: {currentTurn: "...", round: 2, turnCount: 0, isRoundComplete: true}
[PvP] 라운드 완료! 에너지 증가 필요
[턴 수신] 내 턴으로 전환, 라운드 완료: true
턴 3이 시작되었습니다! 라운드 완료로 에너지가 회복되었습니다.
```

---

## 🎯 에너지 증가 타이밍

### 라운드 1

```
선공 턴 1:
  - 에너지: 1/1
  - 카드 사용
  - 턴 종료
  
후공 턴 2:
  - 에너지: 1/1 (아직 증가 안 함!)
  - 카드 사용
  - 턴 종료
  
→ 라운드 1 완료!
```

### 라운드 2

```
선공 턴 3:
  - 에너지: 1 → 2 ✅ (라운드 완료로 증가)
  - 카드 드로우
  - 카드 사용
  - 턴 종료
  
후공 턴 4:
  - 에너지: 1 → 2 ✅ (라운드 완료로 증가)
  - 카드 드로우
  - 카드 사용
  - 턴 종료
  
→ 라운드 2 완료!
```

---

## ✅ 성공 확인 체크리스트

### HP 감소 (양방향)

- [ ] 선공 공격 → 후공 HP 감소 ✅
- [ ] 후공 콘솔: 디버그 로그 대량 출력
- [ ] 후공 화면: HP 바 감소
- [ ] 후공 공격 → 선공 HP 감소 ✅
- [ ] 선공 콘솔: 디버그 로그 대량 출력
- [ ] 선공 화면: HP 바 감소

### 에너지 (라운드 기반)

- [ ] 라운드 1, 턴 1 (선공): 에너지 1
- [ ] 라운드 1, 턴 2 (후공): 에너지 1 (증가 안 함)
- [ ] 라운드 2, 턴 3 (선공): 에너지 2 (증가!)
- [ ] 라운드 2, 턴 4 (후공): 에너지 2 (증가!)
- [ ] 라운드 3, 턴 5 (선공): 에너지 3 (증가!)

### 기타

- [ ] 랜덤 선공 (매번 다름)
- [ ] 상대 나가기 → 알림 + 종료
- [ ] 카드 효과 (HEAL, SHIELD 등)

---

## 🐛 만약 여전히 안 되면?

### 가장 먼저 확인

**선공 콘솔에서 후공이 공격했을 때**:

```
[PvP] ✅ game:cardPlayed 이벤트 수신!
```

이 로그가 **나오나요**?

- **나온다** → 피해 처리 문제 → 아래 로그 확인
- **안 나온다** → Socket 연결 문제 → 서버 재시작

### Socket 연결 확인

양쪽 콘솔:

```javascript
console.log('Socket 연결:', socket?.connected);
console.log('Socket ID:', socket?.id);
```

둘 다 `true`여야 함!

### 리듀서 호출 확인

```
[리듀서] 🔥 RECEIVE_PVP_DAMAGE 액션 실행!
```

이 로그가 **안 나오면** → dispatch가 호출 안 됨

---

## 🎊 완료!

**모든 수정이 완료되었습니다!**

### 변경 사항

1. ✅ **대량 디버그 로그** (문제 추적 용이)
2. ✅ **라운드 시스템** (선공+후공 1번씩 = 1라운드)
3. ✅ **에너지 공평 분배** (라운드 종료 시 양쪽 동시 증가)
4. ✅ **HP 감소 확실** (후공 → 선공도 작동)
5. ✅ **랜덤 선공** (50% 확률)
6. ✅ **상대 나가기 처리**

---

## 🚀 지금 테스트!

서버가 백그라운드에서 실행 중입니다.

```
http://localhost:5173
```

**F12 콘솔을 양쪽 다 열고 로그를 보면서 테스트하세요!**

모든 동작이 로그로 출력됩니다! 📊✨

---

**이제 완벽한 PvP 대전이 가능합니다!** ⚔️🎮💎





